:toc:
:source-highlighter: highlightjs

== elastic stack

=== elasticsearch

==== 使用 xpack

.elasticsearch.yml
[source,yml]
----
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
----

==== 节点间 ssl 通信配置

.证书生成
[source,shell]
----

----

.elasticsearch.yml
[source,yml]
----
# 配置使用PKCS#12格式的证书
xpack.security.transport.ssl.verification_mode: certificate #认证方式使用证书
xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12

#配置使用 -pem生成PEM格式的证书
xpack.security.transport.ssl.verification_mode: certificate 
xpack.security.transport.ssl.key: /home/es/config/node01.key # 私钥
xpack.security.transport.ssl.certificate: /home/es/config/node01.crt # 证书
xpack.security.transport.ssl.certificate_authorities: [ "/home/es/config/ca.crt" ]
----

.告知 es 证书口令
[source,shell]
----
# 如果你生成的node证书设置了 password，那么需要把 password 加入到 elasticsearch 的keystore
# p12 格式
bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password

# PEM格式
bin/elasticsearch-keystore add xpack.security.transport.ssl.secure_key_passphrase
----

==== 开启 basic 

.elasticsearch.yml
[source,yml]
----
http.cors.enabled: true
http.cors.allow-origin: "*"
http.cors.allow-headers: Authorization
----

.进入 es docker 容器内执行命令，设置密码
[source,shell]
----
> elasticsearch-setup-passwords interactive

Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.
You will be prompted to enter passwords as the process progresses.
Please confirm that you would like to continue [y/N]y


Enter password for [elastic]:
Reenter password for [elastic]:
Passwords do not match.
Try again.
Enter password for [elastic]:
Reenter password for [elastic]:
Enter password for [apm_system]:
Reenter password for [apm_system]:
Enter password for [kibana_system]:
Reenter password for [kibana_system]:
Enter password for [logstash_system]:
Reenter password for [logstash_system]:
Passwords do not match.
Try again.
Enter password for [logstash_system]:
Reenter password for [logstash_system]:
Enter password for [beats_system]:
Reenter password for [beats_system]:
Enter password for [remote_monitoring_user]:
Reenter password for [remote_monitoring_user]:
Changed password for user [apm_system]
Changed password for user [kibana_system]
Changed password for user [kibana]
Changed password for user [logstash_system]
Changed password for user [beats_system]
Changed password for user [remote_monitoring_user]
Changed password for user [elastic]
----

用户管理相关 api

GET _security/user


=== 使用 searchguard 插件
